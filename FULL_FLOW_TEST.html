<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Full Flow: ƒêƒÉng nh·∫≠p ‚Üí C∆° s·ªü ‚Üí Ph√≤ng ‚Üí ƒê·∫∑t ph√≤ng ‚Üí Thanh to√°n</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .step { background: #f8f9fa; margin: 15px 0; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff; }
        .step h3 { margin-top: 0; color: #007bff; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .current-data { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üè® Test Full Booking Flow</h1>
    <p>Test ho√†n ch·ªânh quy tr√¨nh: <strong>ƒêƒÉng nh·∫≠p ‚Üí T·∫°o c∆° s·ªü ‚Üí T·∫°o ph√≤ng ‚Üí ƒê·∫∑t ph√≤ng ‚Üí Thanh to√°n</strong></p>

    <!-- Step 1: Authentication -->
    <div class="step">
        <h3>üîê B∆∞·ªõc 1: ƒêƒÉng nh·∫≠p (Development Login)</h3>
        <p style="color: #d63384; background: #f8d7da; padding: 10px; border-radius: 4px;">
            ‚ö†Ô∏è <strong>L∆ØU √ù:</strong> DevController ƒë√£ b·ªã x√≥a ƒë·ªÉ cleanup code. 
            ƒê·ªÉ test ƒë∆∞·ª£c, c·∫ßn t·∫°o l·∫°i DevController ho·∫∑c s·ª≠ d·ª•ng Firebase Auth th·∫≠t.
        </p>
        <div class="form-group">
            <label for="userId">User ID (1=ChuCoSo, 2=KhachHang):</label>
            <input type="number" id="userId" value="1" min="1">
        </div>
        <button onclick="devLogin()" disabled>ƒêƒÉng nh·∫≠p Development (T·∫°m t·∫Øt)</button>
        <div id="loginResult"></div>
    </div>

    <!-- Step 2: Create Accommodation -->
    <div class="step hidden" id="step2">
        <h3>üè¢ B∆∞·ªõc 2: T·∫°o c∆° s·ªü l∆∞u tr√∫</h3>
        <div class="grid">
            <div>
                <div class="form-group">
                    <label for="tenCoSo">T√™n c∆° s·ªü:</label>
                    <input type="text" id="tenCoSo" value="Hotel Test ABC">
                </div>
                <div class="form-group">
                    <label for="moTa">M√¥ t·∫£:</label>
                    <textarea id="moTa">Kh√°ch s·∫°n test v·ªõi ƒë·∫ßy ƒë·ªß ti·ªán nghi</textarea>
                </div>
                <div class="form-group">
                    <label for="soTaiKhoan">S·ªë t√†i kho·∫£n:</label>
                    <input type="text" id="soTaiKhoan" value="1234567890">
                </div>
                <div class="form-group">
                    <label for="tenTaiKhoan">T√™n t√†i kho·∫£n:</label>
                    <input type="text" id="tenTaiKhoan" value="Nguyen Van A">
                </div>
                <div class="form-group">
                    <label for="tenNganHang">Ng√¢n h√†ng:</label>
                    <select id="tenNganHang">
                        <option value="Vietcombank">Vietcombank</option>
                        <option value="Vietinbank">Vietinbank</option>
                        <option value="BIDV">BIDV</option>
                    </select>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label for="soNha">S·ªë nh√†:</label>
                    <input type="text" id="soNha" value="123">
                </div>
                <div class="form-group">
                    <label for="phuong">Ph∆∞·ªùng/X√£:</label>
                    <input type="text" id="phuong" value="Ph∆∞·ªùng Tr·∫ßn H∆∞ng ƒê·∫°o">
                </div>
                <div class="form-group">
                    <label for="quan">Qu·∫≠n/Huy·ªán:</label>
                    <input type="text" id="quan" value="Qu·∫≠n Ho√†n Ki·∫øm">
                </div>
                <div class="form-group">
                    <label for="thanhPho">T·ªânh/Th√†nh ph·ªë:</label>
                    <input type="text" id="thanhPho" value="H√† N·ªôi">
                </div>
                <div class="form-group">
                    <label for="kinhDo">Kinh ƒë·ªô:</label>
                    <input type="number" id="kinhDo" value="105.804817" step="0.000001">
                </div>
                <div class="form-group">
                    <label for="viDo">Vƒ© ƒë·ªô:</label>
                    <input type="number" id="viDo" value="21.028511" step="0.000001">
                </div>
            </div>
        </div>
        <button onclick="createAccommodation()">T·∫°o C∆° S·ªü L∆∞u Tr√∫</button>
        <div id="accommodationResult"></div>
    </div>

    <!-- Step 3: Create Room -->
    <div class="step hidden" id="step3">
        <h3>üõèÔ∏è B∆∞·ªõc 3: T·∫°o ph√≤ng</h3>
        <div class="grid">
            <div>
                <div class="form-group">
                    <label for="tenPhong">T√™n ph√≤ng:</label>
                    <input type="text" id="tenPhong" value="Ph√≤ng Deluxe 101">
                </div>
                <div class="form-group">
                    <label for="giaPhong">Gi√° ph√≤ng (VNƒê):</label>
                    <input type="number" id="giaPhong" value="1500000">
                </div>
                <div class="form-group">
                    <label for="moTaPhong">M√¥ t·∫£ ph√≤ng:</label>
                    <textarea id="moTaPhong">Ph√≤ng deluxe v·ªõi view ƒë·∫πp, ƒë·∫ßy ƒë·ªß ti·ªán nghi</textarea>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label for="soGiuong">S·ªë gi∆∞·ªùng:</label>
                    <input type="number" id="soGiuong" value="2">
                </div>
                <div class="form-group">
                    <label for="dienTich">Di·ªán t√≠ch (m¬≤):</label>
                    <input type="number" id="dienTich" value="35">
                </div>
                <div class="form-group">
                    <label for="sucChua">S·ª©c ch·ª©a (ng∆∞·ªùi):</label>
                    <input type="number" id="sucChua" value="4">
                </div>
            </div>
        </div>
        <button onclick="createRoom()">T·∫°o Ph√≤ng</button>
        <div id="roomResult"></div>
    </div>

    <!-- Step 4: Create Booking -->
    <div class="step hidden" id="step4">
        <h3>üìÖ B∆∞·ªõc 4: ƒê·∫∑t ph√≤ng (Switch to KhachHang)</h3>
        <div class="info">
            <strong>L∆∞u √Ω:</strong> ƒê·ªÉ ƒë·∫∑t ph√≤ng, c·∫ßn ƒëƒÉng nh·∫≠p v·ªõi vai tr√≤ KhachHang (User ID = 2)
        </div>
        <button onclick="switchToCustomer()">Chuy·ªÉn sang t√†i kho·∫£n Kh√°ch h√†ng</button>
        
        <div class="grid">
            <div>
                <div class="form-group">
                    <label for="ngayNhanPhong">Ng√†y nh·∫≠n ph√≤ng:</label>
                    <input type="date" id="ngayNhanPhong">
                </div>
                <div class="form-group">
                    <label for="ngayTraPhong">Ng√†y tr·∫£ ph√≤ng:</label>
                    <input type="date" id="ngayTraPhong">
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label for="tongTien">T·ªïng ti·ªÅn (VNƒê):</label>
                    <input type="number" id="tongTien" value="3000000" readonly>
                </div>
            </div>
        </div>
        <button onclick="createBooking()">ƒê·∫∑t Ph√≤ng</button>
        <div id="bookingResult"></div>
    </div>

    <!-- Step 5: Payment -->
    <div class="step hidden" id="step5">
        <h3>üí≥ B∆∞·ªõc 5: Thanh to√°n VNPay</h3>
        <div class="grid">
            <div>
                <div class="form-group">
                    <label for="paymentType">Lo·∫°i thanh to√°n:</label>
                    <select id="paymentType">
                        <option value="deposit">Thanh to√°n c·ªçc (30%)</option>
                        <option value="full">Thanh to√°n ƒë·∫ßy ƒë·ªß</option>
                        <option value="topup">Thanh to√°n b·ªï sung</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bankCode">Ng√¢n h√†ng (t√πy ch·ªçn):</label>
                    <select id="bankCode">
                        <option value="">Ch·ªçn tr√™n VNPay</option>
                        <option value="NCB">NCB</option>
                        <option value="BIDV">BIDV</option>
                        <option value="VCB">Vietcombank</option>
                        <option value="VTB">Vietinbank</option>
                    </select>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label for="orderInfo">M√¥ t·∫£ thanh to√°n:</label>
                    <input type="text" id="orderInfo" value="Thanh toan dat phong khach san">
                </div>
            </div>
        </div>
        <button onclick="createPayment()">T·∫°o Thanh To√°n VNPay</button>
        <div id="paymentResult"></div>
    </div>

    <!-- Current Data Display -->
    <div class="current-data">
        <h3>üìä D·ªØ li·ªáu hi·ªán t·∫°i</h3>
        <div id="currentData">
            <p>Ch∆∞a c√≥ d·ªØ li·ªáu</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let authToken = null;
        let currentUser = null;
        let currentAccommodation = null;
        let currentRoom = null;
        let currentBooking = null;

        // Set today and tomorrow as default dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            document.getElementById('ngayNhanPhong').value = today.toISOString().split('T')[0];
            document.getElementById('ngayTraPhong').value = tomorrow.toISOString().split('T')[0];
        });

        async function devLogin() {
            const userId = document.getElementById('userId').value;
            try {
                showResult('loginResult', 'ƒêang ƒëƒÉng nh·∫≠p...', 'info');
                
                const response = await fetch(`${API_BASE}/dev/token?userId=${userId}`);
                const result = await response.json();
                
                if (result.success) {
                    authToken = result.data.accessToken;
                    
                    // Get user info
                    const userResponse = await fetch(`${API_BASE}/user/me`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const userData = await userResponse.json();
                    
                    if (userData.success) {
                        currentUser = userData.data;
                        showResult('loginResult', `ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Ch√†o ${currentUser.hoTen} (${currentUser.vaiTro})`, 'success');
                        document.getElementById('step2').classList.remove('hidden');
                        updateCurrentData();
                    }
                } else {
                    showResult('loginResult', `L·ªói ƒëƒÉng nh·∫≠p: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        async function createAccommodation() {
            if (!authToken) {
                showResult('accommodationResult', 'Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc', 'error');
                return;
            }

            try {
                showResult('accommodationResult', 'ƒêang t·∫°o c∆° s·ªü l∆∞u tr√∫...', 'info');
                
                const formData = new FormData();
                formData.append('tenCoSo', document.getElementById('tenCoSo').value);
                formData.append('moTa', document.getElementById('moTa').value);
                formData.append('soTaiKhoan', document.getElementById('soTaiKhoan').value);
                formData.append('tenTaiKhoan', document.getElementById('tenTaiKhoan').value);
                formData.append('tenNganHang', document.getElementById('tenNganHang').value);
                formData.append('soNha', document.getElementById('soNha').value);
                formData.append('phuong', document.getElementById('phuong').value);
                formData.append('quan', document.getElementById('quan').value);
                formData.append('thanhPho', document.getElementById('thanhPho').value);
                formData.append('kinhDo', document.getElementById('kinhDo').value);
                formData.append('viDo', document.getElementById('viDo').value);

                const response = await fetch(`${API_BASE}/cosoluutru`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    currentAccommodation = result.data;
                    showResult('accommodationResult', `T·∫°o c∆° s·ªü th√†nh c√¥ng! ID: ${currentAccommodation.Id}`, 'success');
                    document.getElementById('step3').classList.remove('hidden');
                    updateCurrentData();
                } else {
                    showResult('accommodationResult', `L·ªói: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('accommodationResult', `L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        async function createRoom() {
            if (!currentAccommodation) {
                showResult('roomResult', 'Vui l√≤ng t·∫°o c∆° s·ªü l∆∞u tr√∫ tr∆∞·ªõc', 'error');
                return;
            }

            try {
                showResult('roomResult', 'ƒêang t·∫°o ph√≤ng...', 'info');
                
                const formData = new FormData();
                formData.append('idCoSoLuuTru', currentAccommodation.Id);
                formData.append('tenPhong', document.getElementById('tenPhong').value);
                formData.append('giaPhong', document.getElementById('giaPhong').value);
                formData.append('moTa', document.getElementById('moTaPhong').value);
                formData.append('soGiuong', document.getElementById('soGiuong').value);
                formData.append('dienTich', document.getElementById('dienTich').value);
                formData.append('sucChua', document.getElementById('sucChua').value);

                const response = await fetch(`${API_BASE}/rooms`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    currentRoom = result.data;
                    showResult('roomResult', `T·∫°o ph√≤ng th√†nh c√¥ng! ID: ${currentRoom.Id}`, 'success');
                    document.getElementById('step4').classList.remove('hidden');
                    updateCurrentData();
                } else {
                    showResult('roomResult', `L·ªói: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('roomResult', `L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        async function switchToCustomer() {
            try {
                const response = await fetch(`${API_BASE}/dev/token?userId=2`);
                const result = await response.json();
                
                if (result.success) {
                    authToken = result.data.accessToken;
                    
                    const userResponse = await fetch(`${API_BASE}/user/me`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const userData = await userResponse.json();
                    
                    if (userData.success) {
                        currentUser = userData.data;
                        showResult('bookingResult', `Chuy·ªÉn sang t√†i kho·∫£n: ${currentUser.hoTen} (${currentUser.vaiTro})`, 'success');
                        updateCurrentData();
                    }
                }
            } catch (error) {
                showResult('bookingResult', `L·ªói: ${error.message}`, 'error');
            }
        }

        async function createBooking() {
            if (!currentRoom) {
                showResult('bookingResult', 'Vui l√≤ng t·∫°o ph√≤ng tr∆∞·ªõc', 'error');
                return;
            }

            try {
                showResult('bookingResult', 'ƒêang ƒë·∫∑t ph√≤ng...', 'info');
                
                const bookingData = {
                    idPhong: currentRoom.Id,
                    ngayNhanPhong: document.getElementById('ngayNhanPhong').value,
                    ngayTraPhong: document.getElementById('ngayTraPhong').value,
                    tongTien: parseInt(document.getElementById('tongTien').value)
                };

                const response = await fetch(`${API_BASE}/bookings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(bookingData)
                });

                const result = await response.json();
                
                if (result.success) {
                    currentBooking = result.data;
                    showResult('bookingResult', `ƒê·∫∑t ph√≤ng th√†nh c√¥ng! ID: ${currentBooking.Id}`, 'success');
                    document.getElementById('step5').classList.remove('hidden');
                    updateCurrentData();
                } else {
                    showResult('bookingResult', `L·ªói: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('bookingResult', `L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        async function createPayment() {
            if (!currentBooking) {
                showResult('paymentResult', 'Vui l√≤ng ƒë·∫∑t ph√≤ng tr∆∞·ªõc', 'error');
                return;
            }

            try {
                showResult('paymentResult', 'ƒêang t·∫°o thanh to√°n...', 'info');
                
                const paymentData = {
                    idDatPhong: currentBooking.Id,
                    paymentType: document.getElementById('paymentType').value,
                    bankCode: document.getElementById('bankCode').value || undefined,
                    orderDescription: document.getElementById('orderInfo').value
                };

                const response = await fetch(`${API_BASE}/payments/create-vnpay-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(paymentData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showResult('paymentResult', `
                        <strong>T·∫°o thanh to√°n th√†nh c√¥ng!</strong><br>
                        S·ªë ti·ªÅn: ${result.data.amount.toLocaleString()} VNƒê<br>
                        M√£ ƒë∆°n h√†ng: ${result.data.orderId}<br>
                        <a href="${result.data.paymentUrl}" target="_blank">
                            <button>M·ªü VNPay ƒë·ªÉ thanh to√°n</button>
                        </a>
                    `, 'success');
                    updateCurrentData();
                } else {
                    showResult('paymentResult', `L·ªói: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('paymentResult', `L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = type;
        }

        function updateCurrentData() {
            const data = {
                'User hi·ªán t·∫°i': currentUser,
                'C∆° s·ªü l∆∞u tr√∫': currentAccommodation,
                'Ph√≤ng': currentRoom,
                'ƒê·∫∑t ph√≤ng': currentBooking,
                'Token': authToken ? 'C√≥' : 'Kh√¥ng'
            };

            let html = '';
            for (const [key, value] of Object.entries(data)) {
                if (value && typeof value === 'object') {
                    html += `<strong>${key}:</strong><br><pre>${JSON.stringify(value, null, 2)}</pre><br>`;
                } else if (value) {
                    html += `<strong>${key}:</strong> ${value}<br>`;
                }
            }

            document.getElementById('currentData').innerHTML = html || '<p>Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
        }
    </script>
</body>
</html>