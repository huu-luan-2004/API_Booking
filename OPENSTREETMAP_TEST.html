<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenStreetMap Integration Test</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        input, button, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 14px; 
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
            margin-top: 10px; 
        }
        button:hover { 
            background: #0056b3; 
        }
        #map { 
            height: 500px; 
            width: 100%; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            margin: 20px 0; 
        }
        .result { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        .hotels-list { 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 10px; 
        }
        .hotel-item { 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
            cursor: pointer; 
        }
        .hotel-item:hover { 
            background: #f8f9fa; 
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            background: white;
            border-bottom-color: #007bff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è OpenStreetMap Integration Test</h1>
        <p>Test c√°c t√≠nh nƒÉng t√≠ch h·ª£p OpenStreetMap cho Hotel Booking API</p>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('geocode')">Geocoding</button>
            <button class="tab" onclick="showTab('reverse')">Reverse Geocoding</button>
            <button class="tab" onclick="showTab('hotels')">Hotels Map</button>
            <button class="tab" onclick="showTab('nearby')">Places Nearby</button>
        </div>

        <!-- Geocoding Tab -->
        <div id="geocode" class="tab-content active">
            <h3>üîç Geocoding - Chuy·ªÉn ƒë·ªãa ch·ªâ th√†nh t·ªça ƒë·ªô</h3>
            <div class="controls">
                <div>
                    <div class="form-group">
                        <label for="address">ƒê·ªãa ch·ªâ c·∫ßn t√¨m:</label>
                        <input type="text" id="address" value="123 Ph∆∞·ªùng Tr·∫ßn H∆∞ng ƒê·∫°o, Qu·∫≠n Ho√†n Ki·∫øm, H√† N·ªôi" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ...">
                    </div>
                    <button onclick="geocodeAddress()">üîç T√¨m t·ªça ƒë·ªô</button>
                    <button onclick="suggestAddress()">üí° G·ª£i √Ω ƒë·ªãa ch·ªâ</button>
                    <div id="geocodeResult"></div>
                </div>
                <div>
                    <div class="form-group">
                        <label>K·∫øt qu·∫£:</label>
                        <div id="coordinatesDisplay">Ch∆∞a c√≥ k·∫øt qu·∫£</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reverse Geocoding Tab -->
        <div id="reverse" class="tab-content">
            <h3>üìç Reverse Geocoding - Chuy·ªÉn t·ªça ƒë·ªô th√†nh ƒë·ªãa ch·ªâ</h3>
            <div class="controls">
                <div>
                    <div class="form-group">
                        <label for="latitude">Vƒ© ƒë·ªô (Latitude):</label>
                        <input type="number" id="latitude" value="21.028511" step="0.000001">
                    </div>
                    <div class="form-group">
                        <label for="longitude">Kinh ƒë·ªô (Longitude):</label>
                        <input type="number" id="longitude" value="105.804817" step="0.000001">
                    </div>
                    <button onclick="reverseGeocode()">üìç T√¨m ƒë·ªãa ch·ªâ</button>
                    <div id="reverseResult"></div>
                </div>
                <div>
                    <div class="form-group">
                        <label>ƒê·ªãa ch·ªâ t√¨m ƒë∆∞·ª£c:</label>
                        <div id="addressDisplay">Ch∆∞a c√≥ k·∫øt qu·∫£</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hotels Map Tab -->
        <div id="hotels" class="tab-content">
            <h3>üè® B·∫£n ƒë·ªì c√°c kh√°ch s·∫°n</h3>
            <div class="controls">
                <div>
                    <div class="form-group">
                        <label for="hotelStatus">Tr·∫°ng th√°i:</label>
                        <select id="hotelStatus">
                            <option value="DaDuyet">ƒê√£ duy·ªát</option>
                            <option value="ChoDuyet">Ch·ªù duy·ªát</option>
                            <option value="">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <button onclick="loadHotelsMap()">üó∫Ô∏è T·∫£i b·∫£n ƒë·ªì kh√°ch s·∫°n</button>
                    <div id="hotelsResult"></div>
                </div>
                <div>
                    <div class="hotels-list" id="hotelsList">
                        <p>Ch∆∞a t·∫£i d·ªØ li·ªáu kh√°ch s·∫°n</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nearby Places Tab -->
        <div id="nearby" class="tab-content">
            <h3>üéØ T√¨m ƒë·ªãa ƒëi·ªÉm g·∫ßn nh·∫•t</h3>
            <div class="controls">
                <div>
                    <div class="form-group">
                        <label for="nearbyLat">Vƒ© ƒë·ªô:</label>
                        <input type="number" id="nearbyLat" value="21.028511" step="0.000001">
                    </div>
                    <div class="form-group">
                        <label for="nearbyLon">Kinh ƒë·ªô:</label>
                        <input type="number" id="nearbyLon" value="105.804817" step="0.000001">
                    </div>
                    <div class="form-group">
                        <label for="category">Lo·∫°i ƒë·ªãa ƒëi·ªÉm:</label>
                        <select id="category">
                            <option value="restaurant">Nh√† h√†ng</option>
                            <option value="bank">Ng√¢n h√†ng</option>
                            <option value="hospital">B·ªánh vi·ªán</option>
                            <option value="school">Tr∆∞·ªùng h·ªçc</option>
                            <option value="shop">C·ª≠a h√†ng</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="radius">B√°n k√≠nh (m√©t):</label>
                        <input type="number" id="radius" value="1000" min="100" max="5000">
                    </div>
                    <button onclick="searchNearby()">üéØ T√¨m ƒë·ªãa ƒëi·ªÉm</button>
                    <div id="nearbyResult"></div>
                </div>
                <div>
                    <div class="hotels-list" id="nearbyList">
                        <p>Ch∆∞a t√¨m ki·∫øm</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div id="map"></div>

        <!-- Distance Calculator -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 20px;">
            <h4>üìè T√≠nh kho·∫£ng c√°ch</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                <div>
                    <label>Lat 1:</label>
                    <input type="number" id="lat1" value="21.028511" step="0.000001">
                </div>
                <div>
                    <label>Lon 1:</label>
                    <input type="number" id="lon1" value="105.804817" step="0.000001">
                </div>
                <div>
                    <label>Lat 2:</label>
                    <input type="number" id="lat2" value="21.0245" step="0.000001">
                </div>
                <div>
                    <label>Lon 2:</label>
                    <input type="number" id="lon2" value="105.8412" step="0.000001">
                </div>
                <button onclick="calculateDistance()">T√≠nh</button>
            </div>
            <div id="distanceResult" style="margin-top: 10px;"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const API_BASE = 'http://localhost:5000/api';
        let map;
        let markersGroup;

        // Initialize map
        function initMap() {
            if (map) return;
            
            map = L.map('map').setView([21.028511, 105.804817], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            markersGroup = L.layerGroup().addTo(map);
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            initMap();
        }

        // Show result helper
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        // Geocoding
        async function geocodeAddress() {
            const address = document.getElementById('address').value;
            if (!address) {
                showResult('geocodeResult', 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ', 'error');
                return;
            }

            try {
                showResult('geocodeResult', 'ƒêang t√¨m ki·∫øm...', 'info');
                
                const response = await fetch(`${API_BASE}/maps/geocode?address=${encodeURIComponent(address)}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    showResult('geocodeResult', `‚úÖ T√¨m th·∫•y: ${data.displayName}`, 'success');
                    document.getElementById('coordinatesDisplay').innerHTML = 
                        `üìç Lat: ${data.latitude}<br>üìç Lon: ${data.longitude}`;
                    
                    // Update map
                    initMap();
                    markersGroup.clearLayers();
                    L.marker([data.latitude, data.longitude])
                        .bindPopup(`<b>${address}</b><br>${data.displayName}`)
                        .addTo(markersGroup);
                    map.setView([data.latitude, data.longitude], 15);
                } else {
                    showResult('geocodeResult', `‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('geocodeResult', `‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }
        }

        // Address suggestions
        async function suggestAddress() {
            const query = document.getElementById('address').value;
            if (!query || query.length < 2) {
                showResult('geocodeResult', 'Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª± ƒë·ªÉ g·ª£i √Ω', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/maps/suggest?query=${encodeURIComponent(query)}&limit=5`);
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const suggestions = result.data.map(item => 
                        `<div class="hotel-item" onclick="selectSuggestion('${item.displayName}', ${item.latitude}, ${item.longitude})">
                            ${item.displayName}
                        </div>`
                    ).join('');
                    
                    showResult('geocodeResult', `üí° G·ª£i √Ω:<div style="border:1px solid #ddd; max-height:200px; overflow-y:auto;">${suggestions}</div>`, 'info');
                } else {
                    showResult('geocodeResult', 'Kh√¥ng t√¨m th·∫•y g·ª£i √Ω n√†o', 'error');
                }
            } catch (error) {
                showResult('geocodeResult', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        function selectSuggestion(address, lat, lon) {
            document.getElementById('address').value = address;
            document.getElementById('coordinatesDisplay').innerHTML = 
                `üìç Lat: ${lat}<br>üìç Lon: ${lon}`;
            
            // Update map
            initMap();
            markersGroup.clearLayers();
            L.marker([lat, lon])
                .bindPopup(`<b>ƒê·ªãa ch·ªâ ƒë√£ ch·ªçn</b><br>${address}`)
                .addTo(markersGroup);
            map.setView([lat, lon], 15);
            
            showResult('geocodeResult', '‚úÖ ƒê√£ ch·ªçn ƒë·ªãa ch·ªâ', 'success');
        }

        // Reverse Geocoding
        async function reverseGeocode() {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            
            if (!lat || !lon) {
                showResult('reverseResult', 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·ªça ƒë·ªô', 'error');
                return;
            }

            try {
                showResult('reverseResult', 'ƒêang t√¨m ƒë·ªãa ch·ªâ...', 'info');
                
                const response = await fetch(`${API_BASE}/maps/reverse-geocode?lat=${lat}&lon=${lon}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    showResult('reverseResult', '‚úÖ T√¨m th·∫•y ƒë·ªãa ch·ªâ', 'success');
                    document.getElementById('addressDisplay').innerHTML = 
                        `üìç ${data.displayName}<br><br>
                         üè† S·ªë nh√†: ${data.address?.houseNumber || 'N/A'}<br>
                         üõ£Ô∏è ƒê∆∞·ªùng: ${data.address?.road || 'N/A'}<br>
                         üèòÔ∏è Ph∆∞·ªùng: ${data.address?.quarter || data.address?.suburb || 'N/A'}<br>
                         üèôÔ∏è Qu·∫≠n: ${data.address?.cityDistrict || 'N/A'}<br>
                         üåÜ Th√†nh ph·ªë: ${data.address?.city || 'N/A'}<br>
                         üó∫Ô∏è T·ªânh: ${data.address?.province || 'N/A'}`;
                    
                    // Update map
                    initMap();
                    markersGroup.clearLayers();
                    L.marker([lat, lon])
                        .bindPopup(`<b>Reverse Geocoding</b><br>${data.displayName}`)
                        .addTo(markersGroup);
                    map.setView([lat, lon], 15);
                } else {
                    showResult('reverseResult', `‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('reverseResult', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        // Load Hotels Map
        async function loadHotelsMap() {
            const status = document.getElementById('hotelStatus').value;
            
            try {
                showResult('hotelsResult', 'ƒêang t·∫£i danh s√°ch kh√°ch s·∫°n...', 'info');
                
                const url = status ? 
                    `${API_BASE}/maps/accommodations?status=${status}` :
                    `${API_BASE}/maps/accommodations`;
                    
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    showResult('hotelsResult', `‚úÖ T√¨m th·∫•y ${result.total} kh√°ch s·∫°n`, 'success');
                    
                    // Update hotels list
                    const hotelsList = result.data.map(hotel => 
                        `<div class="hotel-item" onclick="focusHotel(${hotel.latitude}, ${hotel.longitude}, '${hotel.tenCoSo}')">
                            <strong>${hotel.tenCoSo}</strong><br>
                            üìç ${hotel.diaChi}<br>
                            üè∑Ô∏è ${hotel.trangThaiDuyet}<br>
                            üìè Lat: ${hotel.latitude}, Lon: ${hotel.longitude}
                        </div>`
                    ).join('');
                    
                    document.getElementById('hotelsList').innerHTML = hotelsList || '<p>Kh√¥ng c√≥ kh√°ch s·∫°n n√†o</p>';
                    
                    // Update map
                    initMap();
                    markersGroup.clearLayers();
                    
                    if (result.data.length > 0) {
                        result.data.forEach(hotel => {
                            const marker = L.marker([hotel.latitude, hotel.longitude])
                                .bindPopup(`
                                    <div>
                                        <h4>${hotel.tenCoSo}</h4>
                                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${hotel.diaChi}</p>
                                        <p><strong>Tr·∫°ng th√°i:</strong> ${hotel.trangThaiDuyet}</p>
                                        ${hotel.moTa ? `<p><strong>M√¥ t·∫£:</strong> ${hotel.moTa}</p>` : ''}
                                        ${hotel.anhUrl ? `<img src="${hotel.anhUrl}" style="width:100%; max-width:200px;" onerror="this.style.display='none'">` : ''}
                                    </div>
                                `)
                                .addTo(markersGroup);
                        });
                        
                        // Fit map to show all markers
                        const group = new L.featureGroup(markersGroup.getLayers());
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                } else {
                    showResult('hotelsResult', `‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('hotelsResult', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        function focusHotel(lat, lon, name) {
            initMap();
            map.setView([lat, lon], 17);
            
            // Find and open popup for this hotel
            markersGroup.eachLayer(layer => {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lon) {
                    layer.openPopup();
                }
            });
        }

        // Search Nearby Places
        async function searchNearby() {
            const lat = document.getElementById('nearbyLat').value;
            const lon = document.getElementById('nearbyLon').value;
            const category = document.getElementById('category').value;
            const radius = document.getElementById('radius').value;
            
            if (!lat || !lon) {
                showResult('nearbyResult', 'Vui l√≤ng nh·∫≠p t·ªça ƒë·ªô', 'error');
                return;
            }

            try {
                showResult('nearbyResult', 'ƒêang t√¨m ki·∫øm...', 'info');
                
                const response = await fetch(`${API_BASE}/maps/nearby?lat=${lat}&lon=${lon}&category=${category}&radius=${radius}`);
                const result = await response.json();
                
                if (result.success) {
                    showResult('nearbyResult', `‚úÖ ${result.message}`, 'success');
                    
                    // Update nearby list
                    const nearbyList = result.data.map(place => 
                        `<div class="hotel-item" onclick="focusPlace(${place.latitude}, ${place.longitude})">
                            <strong>${place.name}</strong><br>
                            üìè C√°ch ${Math.round(place.distance)}m<br>
                            üè∑Ô∏è Lo·∫°i: ${place.type || 'N/A'}
                        </div>`
                    ).join('');
                    
                    document.getElementById('nearbyList').innerHTML = nearbyList || '<p>Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm n√†o</p>';
                    
                    // Update map
                    initMap();
                    markersGroup.clearLayers();
                    
                    // Add center marker
                    L.marker([lat, lon], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    })
                    .bindPopup('<b>ƒêi·ªÉm t√¨m ki·∫øm</b>')
                    .addTo(markersGroup);
                    
                    // Add nearby places
                    result.data.forEach(place => {
                        L.marker([place.latitude, place.longitude])
                            .bindPopup(`
                                <div>
                                    <h4>${place.name}</h4>
                                    <p><strong>Lo·∫°i:</strong> ${place.type || 'N/A'}</p>
                                    <p><strong>Kho·∫£ng c√°ch:</strong> ${Math.round(place.distance)}m</p>
                                </div>
                            `)
                            .addTo(markersGroup);
                    });
                    
                    map.setView([lat, lon], 15);
                } else {
                    showResult('nearbyResult', `‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('nearbyResult', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        function focusPlace(lat, lon) {
            initMap();
            map.setView([lat, lon], 18);
            
            // Find and open popup for this place
            markersGroup.eachLayer(layer => {
                if (layer.getLatLng().lat === lat && layer.getLatLng().lng === lon) {
                    layer.openPopup();
                }
            });
        }

        // Calculate Distance
        async function calculateDistance() {
            const lat1 = document.getElementById('lat1').value;
            const lon1 = document.getElementById('lon1').value;
            const lat2 = document.getElementById('lat2').value;
            const lon2 = document.getElementById('lon2').value;
            
            if (!lat1 || !lon1 || !lat2 || !lon2) {
                showResult('distanceResult', 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·ªça ƒë·ªô', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/maps/distance?lat1=${lat1}&lon1=${lon1}&lat2=${lat2}&lon2=${lon2}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('distanceResult').innerHTML = 
                        `<div class="result success">
                            üìè Kho·∫£ng c√°ch: <strong>${data.distance}m</strong> (${data.distanceKm}km)
                        </div>`;
                    
                    // Show on map
                    initMap();
                    markersGroup.clearLayers();
                    
                    L.marker([lat1, lon1]).bindPopup('ƒêi·ªÉm A').addTo(markersGroup);
                    L.marker([lat2, lon2]).bindPopup('ƒêi·ªÉm B').addTo(markersGroup);
                    L.polyline([[lat1, lon1], [lat2, lon2]], {color: 'red'}).addTo(markersGroup);
                    
                    const group = new L.featureGroup(markersGroup.getLayers());
                    map.fitBounds(group.getBounds().pad(0.1));
                } else {
                    showResult('distanceResult', `‚ùå ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('distanceResult', `‚ùå L·ªói: ${error.message}`, 'error');
            }
        }

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initMap, 500);
        });
    </script>
</body>
</html>